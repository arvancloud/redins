variables:
  DOCKER_DRIVER: overlay
services:
    - labreg.arvancloud.com:5000/docker:dind
before_script:
    - ls
    - pwd
    - export GOPATH=/root/go
    - export PATH=$PATH:/opt/go/bin
    - mkdir -p $GOPATH/src/arvancloud/
    - ln -sf `pwd` $GOPATH/src/arvancloud/redins

stages:
    - test-lab
    - test-production
    - deploy-lab
    - deploy-production

test-lab:
    stage: test-lab
    image: labreg.arvancloud.com:5000/shared_runner:latest
    script:
        - echo test
        - redis-server &
        - cd $GOPATH/src/arvancloud/redins
        - go get
        - go build
        - go test ./...
    artifacts:
        paths:
        - ./redins
    only:
        - dev

test-production:
    stage: test-production
    image: labreg.arvancloud.com:5000/shared_runner:latest
    script:
        - echo test
        - redis-server &
        - cd $GOPATH/src/arvancloud/redins
        - go get
        - go build
        - go test ./...
    artifacts:
        paths:
        - ./redins
    only:
        - master
    only:
        - tags

deploy-lab:
    stage: deploy-lab
    image: labreg.arvancloud.com:5000/docker:latest
    dependencies:
    - test-lab
    script:
        - echo deploy-lab
        - docker login labreg.arvancloud.com:5000 -u $REPO_USR -p $REPO_PWD
        - docker build . -t labreg.arvancloud.com:5000/arvan_redins:$CI_PIPELINE_ID -t labreg.arvancloud.com:5000/arvan_redins:latest
        - docker push labreg.arvancloud.com:5000/arvan_redins:$CI_PIPELINE_ID 
        - docker push labreg.arvancloud.com:5000/arvan_redins:latest
    only:
        - dev

deploy-production:
    stage: deploy-production
    image: labreg.arvancloud.com:5000/docker:latest
    dependencies:
    - test-production
    script:
        - echo deploy-production
        - docker login reg.arvancloud.com:5000 -u $PROD_REPO_USR -p $PROD_REPO_PWD
        - docker build . -t reg.arvancloud.com:5000/arvan_redins:${CI_COMMIT_TAG}-production 
        - docker push reg.arvancloud.com:5000/arvan_redins:${CI_COMMIT_TAG}-production 
    only:
        - master
    only:
        - tags
